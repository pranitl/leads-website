---
import Layout from '../../../layouts/Layout.astro';
import LeadCaptureSection from '../../../components/LeadCaptureSection.astro';
import FAQList from '../../../components/FAQList.astro';
import { getCollection } from 'astro:content';
import { toLeadFormServiceOptions } from '../../../lib/services';

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  const services = await getCollection('services');

  const serviceOptions = toLeadFormServiceOptions(services);

  return locations.map((location) => {
    const [stateSegment, citySegment] = location.data.slug.split('/');
    return {
      params: { state: stateSegment, city: citySegment },
      props: {
        location,
        allServices: serviceOptions,
      },
    };
  });
}

const { location, allServices } = Astro.props;
const data = location.data;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'City',
  name: `${data.city}, ${data.state}`,
  description: data.intro,
};
---

<Layout title={`${data.city}, ${data.state} | Austin Home Renovation Hub`} description={data.intro} structuredData={structuredData}>
  <LeadCaptureSection
    services={allServices}
    eyebrow={data.state}
    title={`${data.city} specialists`}
    description={data.intro}
    formClassName="shadow-card"
  >
    {data.popularServices?.length ? (
      <div class="space-y-3">
        <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Popular services</p>
        <ul class="space-y-2 text-sm text-neutral-600">
          {data.popularServices.map((slug) => {
            const [serviceSlug, subSlug] = slug.split('/');
            const service = allServices.find((svc) => svc.slug === serviceSlug);
            const sub = service?.subservices?.find((item) => item.slug === subSlug);
            return (
              <li>
                <a class="inline-flex items-center gap-2 text-brand-600 hover:text-brand-700" href={sub ? `/services/${serviceSlug}/${subSlug}` : `/services/${serviceSlug}`}>
                  <span class="inline-flex h-1.5 w-1.5 rounded-full bg-brand-500"></span>
                  {sub ? `${sub.name} (${service?.name})` : service?.name}
                </a>
              </li>
            );
          })}
        </ul>
      </div>
    ) : null}
    {data.neighborhoods?.length ? (
      <p class="text-xs uppercase tracking-wide text-neutral-500">Neighborhoods: {data.neighborhoods.join(', ')}</p>
    ) : null}
  </LeadCaptureSection>

  <section class="container space-y-12 py-16">
    <FAQList
      items={[
        {
          q: 'How quickly will I hear from specialists?',
          a: 'We introduce you to 2-3 vetted teams serving ' + data.city + ' within 24 hours of receiving your form.',
        },
        {
          q: 'Do you work with HOA or city permitting?',
          a: 'Yes. Our concierge team coordinates with HOAs and city reviewers to keep your project compliant in ' + data.state + '.',
        },
      ]}
    />
  </section>
</Layout>
