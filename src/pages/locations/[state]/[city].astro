---
import Layout from '../../../layouts/Layout.astro';
import LeadCaptureSection from '../../../components/LeadCaptureSection.astro';
import FAQList from '../../../components/FAQList.astro';
import { getCollection } from 'astro:content';
import { toLeadFormServiceOptions } from '../../../lib/services';

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  const services = await getCollection('services');

  const serviceOptions = toLeadFormServiceOptions(services);

  return locations.map((location) => {
    const [stateSegment, citySegment] = location.data.slug.split('/');
    return {
      params: { state: stateSegment, city: citySegment },
      props: {
        location,
        allServices: serviceOptions,
      },
    };
  });
}

const { location, allServices } = Astro.props;
const data = location.data;

const citySchema = {
  '@context': 'https://schema.org',
  '@type': 'City',
  name: `${data.city}, ${data.state}`,
  description: data.intro,
  address: {
    '@type': 'PostalAddress',
    addressLocality: data.city,
    addressRegion: data.state,
    addressCountry: 'US',
  },
};

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: `Home renovation services in ${data.city}, ${data.state}`,
  description: data.intro,
  provider: {
    '@type': 'Organization',
    name: 'Austin Home Renovation Hub',
  },
  areaServed: {
    '@type': 'Place',
    name: `${data.city}, ${data.state}, United States`,
  },
};

const faqItems = [
  {
    q: 'How quickly will I hear from specialists?',
    a: 'We introduce you to 2-3 vetted teams serving ' + data.city + ' within 24 hours of receiving your form.',
  },
  {
    q: 'Do you work with HOA or city permitting?',
    a: 'Many of our partnered professionals have experience with HOA requirements and permitting processes. Discuss any specific requirements with your chosen provider.',
  },
];

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqItems.map((item) => ({
    '@type': 'Question',
    name: item.q,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.a,
    },
  })),
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: new URL('/', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Locations',
      item: new URL('/locations', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: data.city,
      item: Astro.url.href,
    },
  ],
};

const structuredData = [citySchema, serviceSchema, faqSchema, breadcrumbSchema];
---

<Layout title={`${data.city} Home Renovation & Landscaping Pros | Austin Reno Hub`} description={data.intro} structuredData={structuredData}>
  <LeadCaptureSection
    services={allServices}
    eyebrow={data.state}
    title={`Vetted specialists in ${data.city}`}
    description={data.intro}
  >
    <!-- Trust badge for local area -->
    <div class="inline-flex items-center gap-2 rounded-full border-2 border-brown-forest/20 bg-cream px-4 py-2 shadow-hard-sm">
      <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current text-oxide" aria-hidden="true">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
      <span class="text-xs font-semibold uppercase tracking-wide text-brown-forest">Serving {data.city} & Surrounding Areas</span>
    </div>

    {data.popularServices?.length ? (
      <div class="space-y-3">
        <p class="text-xs font-semibold uppercase tracking-wide text-brown-muted">Popular services in {data.city}</p>
        <ul class="space-y-2 text-sm text-brown-body">
          {data.popularServices.map((slug) => {
            const [serviceSlug, subSlug] = slug.split('/');
            const service = allServices.find((svc) => svc.slug === serviceSlug);
            const sub = service?.subservices?.find((item) => item.slug === subSlug);
            return (
              <li>
                <a class="inline-flex items-center gap-2 text-oxide hover:text-oxide-hover" href={sub ? `/services/${serviceSlug}/${subSlug}` : `/services/${serviceSlug}`}>
                  <span class="inline-flex h-1.5 w-1.5 rounded-full bg-oxide"></span>
                  {sub ? `${sub.name} (${service?.name})` : service?.name}
                </a>
              </li>
            );
          })}
        </ul>
      </div>
    ) : null}
    {data.neighborhoods?.length ? (
      <div class="space-y-2">
        <p class="text-xs font-semibold uppercase tracking-wide text-brown-muted">Key neighborhoods</p>
        <div class="flex flex-wrap gap-2">
          {data.neighborhoods.map((neighborhood) => (
            <span class="rounded-full border border-brown-forest/20 bg-cream px-3 py-1 text-xs font-medium text-brown-body">{neighborhood}</span>
          ))}
        </div>
      </div>
    ) : null}
  </LeadCaptureSection>

  <section class="container space-y-20 py-16">
    
    {/* Market Context */}
    {data.marketInsights && (
      <div class="grid gap-12 lg:grid-cols-2">
        <div class="space-y-6">
           <h2 class="font-heading text-3xl font-semibold text-brown-dark">{data.marketInsights.title ?? `Why ${data.city} homeowners choose our network`}</h2>
           <p class="text-lg leading-relaxed text-brown-body">{data.marketInsights.description}</p>
        </div>
        <div class="rounded-2xl bg-cream-light p-8 shadow-hard-light">
             <h3 class="font-heading text-xl font-semibold text-brown-dark mb-6">The Standard vs. Vetted Difference</h3>
             <ul class="space-y-4">
                <li class="flex items-start gap-3 text-brown-body">
                   <span class="mt-1 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-red-600 text-xs font-bold">✕</span>
                   <span><strong class="text-brown-dark">Generic Search:</strong> Often "Jack of all trades" contractors who may ignore local soil & zoning nuances.</span>
                </li>
                <li class="flex items-start gap-3 text-brown-body">
                   <span class="mt-1 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-oxide text-cream text-xs font-bold">✓</span>
                   <span><strong class="text-brown-dark">Our Network:</strong> Specialists verified for experience with {data.city}'s specific terrain and codes.</span>
                </li>
                <li class="flex items-start gap-3 text-brown-body">
                   <span class="mt-1 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-oxide text-cream text-xs font-bold">✓</span>
                   <span><strong class="text-brown-dark">Transparent Quality:</strong> We prioritize pros with proven track records in your neighborhood.</span>
                </li>
             </ul>
        </div>
      </div>
    )}

    {/* Climate Challenges */}
    {data.climateChallenges?.length && (
      <div class="space-y-10">
        <div class="max-w-2xl">
          <h2 class="font-heading text-3xl font-semibold text-brown-dark">Why {data.city} homes need specialized care</h2>
          <p class="mt-4 text-brown-body">Local terrain and weather dictate how projects should be built. Our pros understand these specific challenges.</p>
        </div>
        <div class="grid gap-6 md:grid-cols-3">
          {data.climateChallenges.map((challenge) => (
             <div class="rounded-2xl border-2 border-brown-forest/10 bg-white p-6 transition hover:border-oxide/30">
                <div class="mb-4 inline-flex h-10 w-10 items-center justify-center rounded-full bg-sage/20 text-sage">
                   <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current" aria-hidden="true">
                      <path d="M12 22c4.97 0 9-4.03 9-9-4.97 0-9-4.03-9-9-4.97 0-9 4.03-9 9 0 4.97 4.03 9 9 9zm0-2c-3.87 0-7-3.13-7-7 3.87 0 7 3.13 7 7 0 3.87-3.13 7-7 7z"/>
                   </svg>
                </div>
                <h3 class="font-heading text-lg font-semibold text-brown-dark">{challenge.title}</h3>
                <p class="mt-3 text-sm leading-relaxed text-brown-body">{challenge.description}</p>
             </div>
          ))}
        </div>
      </div>
    )}

    {/* Neighborhoods Detail */}
    {(data.neighborhoodDescription || data.serviceAreaOverview) && (
       <div class="relative overflow-hidden rounded-3xl bg-brown-forest p-8 text-cream lg:p-12">
          <div class="relative z-10 max-w-3xl space-y-6">
             <h2 class="font-heading text-3xl font-semibold text-cream">Serving {data.city}'s neighborhoods</h2>
             {data.neighborhoodDescription && (
               <p class="text-lg leading-relaxed text-cream/90">{data.neighborhoodDescription}</p>
             )}
             {data.serviceAreaOverview && (
                <div class="border-t border-cream/20 pt-6">
                   <p class="font-semibold text-cream/80 uppercase tracking-wider text-sm">Service Coverage</p>
                   <p class="mt-2 text-cream/80">{data.serviceAreaOverview}</p>
                </div>
             )}
          </div>
          
          {/* Decorative pattern */}
          <svg class="absolute -bottom-12 -right-12 h-64 w-64 text-cream/5" viewBox="0 0 100 100" fill="currentColor">
             <path d="M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm0 80c-16.6 0-30-13.4-30-30s13.4-30 30-30 30 13.4 30 30-13.4 30-30 30z"/>
          </svg>
       </div>
    )}

    <div class="border-t border-brown-forest/10 pt-16">
      <h2 class="mb-8 font-heading text-3xl font-semibold text-brown-dark">Frequently asked questions about {data.city} services</h2>
      <FAQList items={faqItems} />
    </div>
  </section>
</Layout>
