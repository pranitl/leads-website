---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../../layouts/Layout.astro';
import LeadCaptureSection from '../../components/LeadCaptureSection.astro';
import FAQList from '../../components/FAQList.astro';
import ProcessSteps from '../../components/ProcessSteps.astro';
import { getCollection } from 'astro:content';
import { toLeadFormServiceOptions } from '../../lib/services';
import landscapingIllustration from '../../assets/images/placeholders/xeriscaping-landscape.webp';
import hardscapeIllustration from '../../assets/images/placeholders/hardscape-retaining-wall.webp';
import closetIllustration from '../../assets/images/placeholders/custom-closet-interior.webp';

export async function getStaticPaths() {
  const services = await getCollection('services');
  const subservices = await getCollection('subservices');

  const serviceOptions = toLeadFormServiceOptions(services);

  return services.map((service) => ({
    params: { service: service.data.slug },
    props: {
      service,
      subserviceEntries: subservices.filter((entry) => entry.data.service === service.data.slug),
      allServices: serviceOptions,
    },
  }));
}

const { service, subserviceEntries, allServices } = Astro.props;
const data = service.data;

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: data.name,
  serviceType: data.name,
  description: data.summary,
  provider: {
    '@type': 'Organization',
    name: 'Austin Home Renovation Hub',
  },
  areaServed: {
    '@type': 'Place',
    name: 'Austin, Texas, United States',
  },
};

const faqSchema =
  data.faqs && data.faqs.length
    ? {
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: data.faqs.map((item) => ({
          '@type': 'Question',
          name: item.q,
          acceptedAnswer: {
            '@type': 'Answer',
            text: item.a,
          },
        })),
      }
    : null;

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: new URL('/', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Services',
      item: new URL('/services', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: data.name,
      item: Astro.url.href,
    },
  ],
};

const structuredData = [serviceSchema, faqSchema, breadcrumbSchema].filter(Boolean);

const illustrationMap: Record<string, ImageMetadata> = {
  landscaping: landscapingIllustration,
  hardscaping: hardscapeIllustration,
  'closet-interior': closetIllustration,
};

const illustration = illustrationMap[data.slug] ?? landscapingIllustration;

// Map process steps to component format
const processSteps = data.process?.map(step => ({
  title: step.title,
  copy: step.description
}));
---

<Layout title={`${data.name} Services in Austin | Vetted Local Pros`} description={data.summary} structuredData={structuredData}>
  <LeadCaptureSection
    services={allServices}
    eyebrow={data.name}
    title={data.heroTitle ?? data.name}
    description={data.heroCopy ?? data.summary}
  >
    <div class="overflow-hidden rounded-2xl border-2 border-brown-forest/20 bg-cream-light">
      <Image
        src={illustration}
        alt={`${data.name} inspiration`}
        widths={[480, 640, 768, 960, 1200]}
        sizes="(min-width: 768px) 50vw, 100vw"
        class="h-48 w-full object-cover"
        loading="lazy"
        decoding="async"
      />
    </div>
    {data.benefits?.length ? (
      <ul class="grid gap-3 sm:grid-cols-2">
        {data.benefits.map((benefit) => (
          <li class="flex items-start gap-2 rounded-2xl border-2 border-brown-forest/20 bg-cream-light p-4 text-sm text-brown-body shadow-hard-light">
            <span class="mt-0.5 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-oxide text-cream">
              <svg viewBox="0 0 20 20" class="h-3 w-3 fill-current" aria-hidden="true">
                <path d="M16.707 5.293a1 1 0 0 1 0 1.414l-8 8a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L8 12.586l7.293-7.293a1 1 0 0 1 1.414 0Z" />
              </svg>
            </span>
            {benefit}
          </li>
        ))}
      </ul>
    ) : null}
  </LeadCaptureSection>

  <section class="container space-y-24 py-16">
    
    {/* What's Included Section */}
    {data.whatsIncluded?.length ? (
      <div class="rounded-3xl border-2 border-brown-forest/20 bg-white p-8 shadow-sm lg:p-12">
        <h2 class="mb-8 font-heading text-3xl font-semibold text-brown-dark">Typical {data.name.toLowerCase()} project inclusions</h2>
        <div class="grid gap-x-8 gap-y-4 md:grid-cols-2 lg:grid-cols-3">
          {data.whatsIncluded.map((item) => (
            <div class="flex items-center gap-3">
              <span class="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full bg-sage/20 text-sage">
                <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current" aria-hidden="true">
                  <path d="M16.707 5.293a1 1 0 0 1 0 1.414l-8 8a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L8 12.586l7.293-7.293a1 1 0 0 1 1.414 0Z" />
                </svg>
              </span>
              <span class="font-medium text-brown-dark">{item}</span>
            </div>
          ))}
        </div>
      </div>
    ) : null}

    {/* Subservices / Specialties */}
    {data.subservices?.length ? (
      <div class="space-y-8">
        <div class="max-w-2xl">
          <h2 class="font-heading text-3xl font-semibold text-brown-dark">Featured specialties</h2>
          <p class="mt-4 text-brown-body">Specific expertise for every part of your project. Select a category to see detailed cost guides and examples.</p>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          {data.subservices.map((sub) => {
            const detail = subserviceEntries.find((entry) => entry.data.slug === sub.slug);
            return (
              <article class="group rounded-2xl border-2 border-brown-forest/20 bg-cream-light p-8 shadow-hard-light transition hover:-translate-x-0.5 hover:-translate-y-0.5 hover:shadow-hard-light-hover">
                <h3 class="font-heading text-xl font-semibold text-brown-dark">{sub.name}</h3>
                <p class="mt-2 text-sm text-brown-body">{detail?.data.intro ?? sub.summary}</p>
                {detail?.data.highlights?.length ? (
                  <ul class="mt-4 space-y-2 text-sm text-brown-body">
                    {detail.data.highlights.map((point) => (
                      <li class="flex items-start gap-2">
                        <span class="mt-1 inline-block h-1.5 w-1.5 rounded-full bg-oxide"></span>
                        <span>{point}</span>
                      </li>
                    ))}
                  </ul>
                ) : null}
                {detail?.data.avgCost ? (
                  <p class="mt-4 inline-flex items-center rounded-full border border-brown-forest/30 bg-cream px-3 py-1 text-xs font-semibold text-brown-body">
                    Typical: ${detail.data.avgCost.min.toLocaleString()} - ${detail.data.avgCost.max.toLocaleString()}
                  </p>
                ) : null}
                <a class="mt-6 inline-flex items-center text-sm font-semibold text-oxide hover:text-oxide-hover" href={`/services/${data.slug}/${sub.slug}`}>
                  Deep dive into {sub.name}
                  <svg viewBox="0 0 24 24" class="ml-1 h-4 w-4 fill-current" aria-hidden="true">
                    <path d="M5 12a1 1 0 0 1 1-1h10.586l-3.293-3.293a1 1 0 0 1 1.414-1.414l5 5a1 1 0 0 1 0 1.414l-5 5a1 1 0 1 1-1.414-1.414L16.586 13H6a1 1 0 0 1-1-1Z" />
                  </svg>
                </a>
              </article>
            );
          })}
        </div>
      </div>
    ) : null}

    {/* Common Problems */}
    {data.commonProblems?.length ? (
      <div class="space-y-8">
        <div class="max-w-2xl">
          <h2 class="font-heading text-3xl font-semibold text-brown-dark">Common challenges our pros solve</h2>
          <p class="mt-4 text-brown-body">Home improvement in Austin comes with unique challenges. Here is how vetted specialists tackle them.</p>
        </div>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-2">
          {data.commonProblems.map((item) => (
            <div class="rounded-2xl bg-cream p-6">
              <h3 class="flex items-center gap-2 font-heading text-lg font-semibold text-oxide">
                <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current" aria-hidden="true">
                  <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10Zm-1-7v2h2v-2h-2Zm0-8v6h2V7h-2Z" />
                </svg>
                {item.problem}
              </h3>
              <p class="mt-3 text-sm leading-relaxed text-brown-body">{item.solution}</p>
            </div>
          ))}
        </div>
      </div>
    ) : null}

    {/* Why Choose Us */}
    {data.whyChooseUs?.length ? (
      <div class="space-y-8">
        <h2 class="font-heading text-3xl font-semibold text-brown-dark">Why homeowners trust our network</h2>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
          {data.whyChooseUs.map((item) => (
            <div class="space-y-3 rounded-2xl border-2 border-brown-forest/10 p-6 transition hover:border-oxide/50">
              <h3 class="font-heading text-lg font-semibold text-brown-dark">{item.title}</h3>
              <p class="text-sm text-brown-body">{item.description}</p>
            </div>
          ))}
        </div>
      </div>
    ) : null}

    {/* Process Section */}
    {processSteps && (
      <ProcessSteps steps={processSteps} />
    )}

    {/* Service Area */}
    {data.serviceArea && (
      <div class="rounded-3xl bg-brown-forest p-8 text-cream lg:p-12">
        <div class="flex flex-col gap-8 lg:flex-row lg:items-start lg:justify-between">
          <div class="max-w-md space-y-4">
            <h2 class="font-heading text-3xl font-semibold text-cream">Service Area</h2>
            <p class="text-cream/80">{data.serviceArea.text}</p>
          </div>
          {data.serviceArea.areas && (
             <div class="grid grid-cols-2 gap-x-8 gap-y-3 sm:grid-cols-3">
               {data.serviceArea.areas.map((area) => (
                 <div class="flex items-center gap-2 text-sm font-medium text-cream">
                   <span class="h-1.5 w-1.5 rounded-full bg-oxide-light"></span>
                   {area}
                 </div>
               ))}
             </div>
          )}
        </div>
      </div>
    )}

    {/* FAQs */}
    <div class="space-y-8">
      <h2 class="font-heading text-3xl font-semibold text-brown-dark">Frequently asked questions</h2>
      <FAQList items={data.faqs ?? []} />
    </div>
  </section>
</Layout>
