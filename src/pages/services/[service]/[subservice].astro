---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../../../layouts/Layout.astro';
import LeadCaptureSection from '../../../components/LeadCaptureSection.astro';
import FAQList from '../../../components/FAQList.astro';
import { getCollection } from 'astro:content';
import { toLeadFormServiceOptions } from '../../../lib/services';
import landscapingIllustration from '../../../assets/images/placeholders/xeriscaping-landscape.webp';
import hardscapeIllustration from '../../../assets/images/placeholders/hardscape-retaining-wall.webp';
import closetIllustration from '../../../assets/images/placeholders/custom-closet-interior.webp';

export async function getStaticPaths() {
  const services = await getCollection('services');
  const subservices = await getCollection('subservices');

  const serviceOptions = toLeadFormServiceOptions(services);

  return subservices.map((sub) => {
    const parent = services.find((svc) => svc.data.slug === sub.data.service);
    return {
      params: { service: sub.data.service, subservice: sub.data.slug },
      props: {
        parent,
        sub,
        allServices: serviceOptions,
      },
    };
  });
}

const { parent, sub, allServices } = Astro.props;
const subData = sub.data;
const serviceName = parent?.data.name ?? 'Service';
const parentSlug = parent?.data.slug ?? 'service';

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: subData.title,
  serviceType: subData.title,
  description: subData.intro,
  provider: {
    '@type': 'Organization',
    name: 'Austin Home Renovation Hub',
  },
  areaServed: {
    '@type': 'Place',
    name: 'Austin, Texas, United States',
  },
};

const faqItems = subData.faqs ?? parent?.data.faqs ?? [];

const faqSchema =
  faqItems && faqItems.length
    ? {
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: faqItems.map((item) => ({
          '@type': 'Question',
          name: item.q,
          acceptedAnswer: {
            '@type': 'Answer',
            text: item.a,
          },
        })),
      }
    : null;

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: new URL('/', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Services',
      item: new URL('/services', Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: serviceName,
      item: new URL(`/services/${parentSlug}`, Astro.url).href,
    },
    {
      '@type': 'ListItem',
      position: 4,
      name: subData.title,
      item: Astro.url.href,
    },
  ],
};

const structuredData = [serviceSchema, faqSchema, breadcrumbSchema].filter(Boolean);

const illustrationMap: Record<string, ImageMetadata> = {
  landscaping: landscapingIllustration,
  hardscaping: hardscapeIllustration,
  'closet-interior': closetIllustration,
};

const illustration = illustrationMap[parentSlug] ?? landscapingIllustration;
---

<Layout title={`${subData.title} | ${serviceName}`} description={subData.intro ?? `${subData.title} specialists`} structuredData={structuredData}>
  <LeadCaptureSection
    services={allServices}
    eyebrow={serviceName}
    title={subData.title}
    description={subData.intro}
  >
    <div class="overflow-hidden rounded-2xl border-2 border-brown-forest/20 bg-cream-light">
      <Image
        src={illustration}
        alt={`${subData.title} inspiration`}
        widths={[480, 640, 768, 960, 1200]}
        sizes="(min-width: 768px) 50vw, 100vw"
        class="h-48 w-full object-cover"
        loading="lazy"
        decoding="async"
      />
    </div>
    {subData.avgCost ? (
      <div class="flex flex-wrap items-center gap-3 rounded-2xl border-2 border-brown-forest/20 bg-cream-light p-4 text-sm text-brown-body shadow-hard-light">
        <span class="rounded-full border border-brown-forest/30 bg-cream px-3 py-1 font-semibold text-brown-forest">Typical investment</span>
        ${subData.avgCost.min.toLocaleString()} - ${subData.avgCost.max.toLocaleString()}
        {subData.avgCost.notes && <span class="text-xs text-brown-muted">({subData.avgCost.notes})</span>}
      </div>
    ) : null}
    {subData.highlights?.length ? (
      <ul class="grid gap-3 sm:grid-cols-2">
        {subData.highlights.map((highlight) => (
          <li class="flex items-start gap-2 rounded-2xl border-2 border-brown-forest/20 bg-cream-light p-4 text-sm text-brown-body shadow-hard-light">
            <span class="mt-0.5 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-oxide text-cream">
              <svg viewBox="0 0 20 20" class="h-3 w-3 fill-current" aria-hidden="true">
                <path d="M16.707 5.293a1 1 0 0 1 0 1.414l-8 8a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L8 12.586l7.293-7.293a1 1 0 0 1 1.414 0Z" />
              </svg>
            </span>
            {highlight}
          </li>
        ))}
      </ul>
    ) : null}
  </LeadCaptureSection>

  <section class="container space-y-12 py-16">
    <FAQList items={subData.faqs ?? parent?.data.faqs ?? []} />
  </section>
</Layout>
